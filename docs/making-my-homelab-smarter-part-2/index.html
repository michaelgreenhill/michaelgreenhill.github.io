<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="HandheldFriendly" content="True"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="generator" content="11ty"/>
<meta name="referrer" content="no-referrer-when-downgrade"/>
<meta name="description" content="IT and Photography"/>

<title>Making my homelab smarter - Part 2</title>

<link rel="stylesheet" type="text/css" href="/css/screen.css?v=ea37315572b4688ec79439d24377c5a1">
<link rel="stylesheet" type="text/css" href="/css/custom.css?v=7a88a16b41070bc778b11cf209426543">
<link rel="shortcut icon" href="/favicon.ico?v=1429123ad6a04f8249a06b6767130736" type="image/x-icon">

<link rel="alternate" type="application/atom+xml" title="" href="/feed.xml?v=6665236f9459354cefc0f8a0ec2552ca">



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-97297631-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-97297631-1');
    </script>

    <link rel="canonical" href="https://michaelgreenhill.net/making-my-homelab-smarter-part-2/"/>

    <meta property="og:site_name" content="Michael Greenhill"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Making my homelab smarter - Part 2"/>
    <meta property="og:description" content="Get routed!"/>
    <meta property="og:url" content="https://michaelgreenhill.net/making-my-homelab-smarter-part-2/"/>
    <meta property="og:image" content="/images/1_1SYWH-QudwNvXrH1VUAlhw.png"/>
    <meta property="article:published_time" content="2020-02-22T04:58:36.000Z"/>
    <meta property="article:modified_time" content="2020-02-22T04:58:36.000Z"/>
    <meta property="article:tag" content="it"/>
    <meta property="article:tag" content="ddos"/>
    <meta property="article:tag" content="nginx"/>

    <meta property="article:publisher" content="https://facebook.com/aspect19"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:title" content="Making my homelab smarter - Part 2"/>
    <meta name="twitter:description" content="Get routed!"/>
    <meta name="twitter:url" content="https://michaelgreenhill.net/making-my-homelab-smarter-part-2/"/>
    <meta name="twitter:image" content="/images/1_1SYWH-QudwNvXrH1VUAlhw.png"/>
    <meta name="twitter:label1" content="Written by"/>
    <meta name="twitter:data1" content=""/>
    <meta name="twitter:label2" content="Filed under"/>
    <meta name="twitter:data2" content="it, ddos, nginx"/>
    <meta property="og:image:width" content="1280"/>
    <meta property="og:image:height" content="919"/>

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "publisher": {
          "@type": "Organization",
          "name": "",
          "logo": {
            "@type": "ImageObject",
            "url": "https://michaelgreenhill.net/favicon.ico",
            "width": 48,
            "height": 48
          }
        },
        "author": {
          "@type": "Person",
          "name": "",
          "image": {
            "@type": "ImageObject",
            "url": "",
            "width": 500,
            "height": 500
          },
          "url": "https://michaelgreenhill.net/author/michael/",
          "sameAs": []
        },
        "headline": "Making my homelab smarter - Part 2",
        "url": "https://michaelgreenhill.net/making-my-homelab-smarter-part-2/",
        "datePublished": "2020-02-22T04:58:36.000Z",
        "dateModified": "2020-02-22T04:58:36.000Z",
        "image": {
          "@type": "ImageObject",
          "url": "/images/1_1SYWH-QudwNvXrH1VUAlhw.png",
          "width": 1280,
          "height": 919
        },
        "keywords": "it, ddos, nginx",
        "description": "Get routed!",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://michaelgreenhill.net/"
        }
      }
    </script>

  </head>
  <body class="post-template">

    <div class="site-wrapper">

      <header class="site-header">
        <div class="outer site-nav-main">
          <div class="inner">
            

<nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
            <a class="site-nav-logo" href="/">Michael Greenhill</a>
            <div class="site-nav-content">
                <ul class="nav" role="menu">
                    <li class="nav-home " role="menuitem">
                        <a href="/">Home</a>
                    </li>
                    <li class="nav-home " role="menuitem">
                        <a href="/tags/">Tags</a>
                    </li>
                    <li class="nav-home " role="menuitem">
                        <a href="/archives/">Archives</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            <a class="social-link social-link-fb" href="https://facebook.com/aspect19" title="Facebook" target="_blank" rel="noopener">
                <svg viewbox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 0c8.837 0 16 7.163 16 16s-7.163 16-16 16S0 24.837 0 16 7.163 0 16 0zm5.204 4.911h-3.546c-2.103 0-4.443.885-4.443 3.934.01 1.062 0 2.08 0 3.225h-2.433v3.872h2.509v11.147h4.61v-11.22h3.042l.275-3.81h-3.397s.007-1.695 0-2.187c0-1.205 1.253-1.136 1.329-1.136h2.054V4.911z"></path>
                </svg>
            </a>
        </div>
    </div>
</nav>
          </div>
        </div>
      </header>

      <main id="site-main" class="site-main outer">
        <div class="inner">
          <article class="post-full post">
            <section class="post-full-content">
              <div class="post-header">
                <h1>Making my homelab smarter - Part 2</h1>

                
                <ol reversed class="taglist" style="counter-reset: start-from 4">




  <li>
    <a href="/tags/homelab" class="taglist-link">homelab</a>
  </li>



  <li>
    <a href="/tags/it" class="taglist-link">it</a>
  </li>


</ol>
                <span class="reading-time">About 3 min reading time</span>

              </div>

              
              <div class="heroimage"><img src="/images/1_1SYWH-QudwNvXrH1VUAlhw.png"></div>
              

              <aside class="post-aside">
                <strong>Contents</strong>
                <nav class="toc"><ol><li><a href="#why-should-i-care-about-pfsense%3F">Why should I care about pfSense?</a></li><li><a href="#give-me-that-sweet-wan">Give me that sweet WAN</a><ol><li><a href="#so-what-does-multi-wan-look-like%3F">So what does multi-WAN look like?</a></li></ol></li><li><a href="#those-were-pretty-pictures%2C-now-what%3F">Those were pretty pictures, now what?</a><ol><li><a href="#tying-it-all-together-with-a-bow">Tying it all together with a bow</a></li></ol></li></ol></nav>
              </aside>
              <div class="post-content">
                <p class="subtitle">Get routed!</p>
                <p>Back in <a href="/making-my-homelab-smarter-part-1/">Part 1</a> I waffled on about the sad state of my internet and what I intended to do about it.</p>
<h2 id="why-should-i-care-about-pfsense%3F">Why should I care about pfSense? <a class="anchor-link" href="#why-should-i-care-about-pfsense%3F">#</a></h2>
<p>Well, in my case, it comes down to a few choice points:</p>
<ul>
<li>Multi-WAN that actually works as it’s supposed to</li>
<li>Policy-based routing</li>
<li>Security in a world of IoT nonsense</li>
<li>IPv6</li>
<li>Observability</li>
</ul>
<p>It’s also open-source and built on FreeBSD — both a bonus from cost and security perspectives.</p>
<h2 id="give-me-that-sweet-wan">Give me that sweet WAN <a class="anchor-link" href="#give-me-that-sweet-wan">#</a></h2>
<p><em>For the uninitiated, “WAN” refers to “Wide Area Network”. It’s a fancy way of saying “internet”.</em></p>
<p>In terms of actual internet connections I have:</p>
<ul>
<li>Internode Naked ADSL2, maxing out at 4mbps down and 400kbps up</li>
<li>Optus 4G with a 500gb data cap</li>
</ul>
<p>So until NBN finally kicks down my door and shoves a 100mbps pipe of memes into my network, I have to make do with a balance of ADSL and 4G.</p>
<h3 id="so-what-does-multi-wan-look-like%3F">So what does multi-WAN look like? <a class="anchor-link" href="#so-what-does-multi-wan-look-like%3F">#</a></h3>
<ul>
<li>Some things should only ever go via ADSL</li>
<li>Some things should only ever go via 4G</li>
<li>Some things should try to go via ADSL and failover to 4G, and</li>
<li>Some things should try to go via 4G and failover to ADSL</li>
<li>Some things should load balance across ADSL and 4G</li>
</ul>
<p>For example; my ADSL connection can happily stream Netflix, Stan, Amazon Prime, YouTube etc. to my 55&quot; TV with “good enough” quality. Therefore, that traffic should only ever go via ADSL, so I don’t blow out my data usage in one binge session of The Witcher (toss a coin, yeah?)</p>
<p>Conversely, low-latency traffic (RDP, SSH) should go via 4G, to stop me from throwing expensive IT equipment in frustration.</p>
<p><img src="/images/1_1SYWH-QudwNvXrH1VUAlhw.png" alt="Don’t you go peeping and my IPs, ya hear me"></p>
<p>Don’t you go peeping and my IPs, ya hear me!</p>
<p>From here I’ve put the gateways into gateway groups — these control failover and load balancing.</p>
<p><img src="/images/1_bJgTd-LKMdIrIIVdCkLPng.png" alt="Annoyingly, IPv6 duplicates everything"></p>
<p>Annoyingly, IPv6 duplicates everything.</p>
<p>We can visualise the failover and gateway preference via the Status &gt; Gateways page:</p>
<p><img src="/images/1_jDsM0PU32ro6rXQDrUweDg.png" alt="A bug in pfSense shows the IPv6 gateways as “Gathering data” here, but elsewhere they are “Online”"></p>
<h2 id="those-were-pretty-pictures%2C-now-what%3F">Those were pretty pictures, now what? <a class="anchor-link" href="#those-were-pretty-pictures%2C-now-what%3F">#</a></h2>
<p>Well, next we need to tell pfSense what should go out via those gateways. As much as I’d like to shout “OK pfSense, send all Netflix through ADSL” it’s just not that clever. Yet.</p>
<p>The next best thing would be to create a firewall rule for anything going to <a href="http://netflix.com">netflix.com</a>. Unfortunately, that won’t work. Because Netflix is so massive and <a href="https://variety.com/2019/digital/news/netflix-loses-title-top-downstream-bandwidth-application-1203330313/">consumes 12.9% of all internet</a> traffic — think about that, for a minute — it has a huge content delivery network, with its Open Connect peering injecting cake videos straight to the ISP networks. It’s also mercurial — servers that are up one minute are downed the next, thanks to Chaos Monkey.</p>
<p>And since this needs to be a <strong>reliable</strong> and <strong>dependable</strong> routing solution, the best approach is to apply the rule to the client. In other words, <strong>all traffic</strong> from my TV and my Chromecast should go via the ADSL gateway. We accomplish this via a firewall alias:</p>
<p><img src="/images/1_GUXrZ862oho5ams1IXC-QQ.png" alt="For testing purposes, I’m allowing these devices to fall back to 4G"></p>
<p>For testing purposes, I’m allowing these devices to fall back to 4G.</p>
<h3 id="tying-it-all-together-with-a-bow">Tying it all together with a bow <a class="anchor-link" href="#tying-it-all-together-with-a-bow">#</a></h3>
<p>Finally, we create a firewall rule to route this traffic accordingly.</p>
<p>Specifying the source as our firewall alias and our destination as “http_ports” (another alias of ports 80 and 443)…</p>
<p><img src="/images/1_9AvJ0Ndfdt9huSSxk8aDaA.png" alt="All streaming services run over HTTPS, so we can limit the rule to just these ports"></p>
<p>All streaming services run over HTTPS, so we can limit the rule to just these ports</p>
<p>Next, we specify the gateway group…</p>
<p><img src="/images/1_KJ9g0FvxpORAhJSvSKAcOw.png" alt="This image has no caption. Surprise!"></p>
<p>…and hey, presto! We have a policy-based route that directs all traffic from my TV and from my Chromecast, over ports 80 and 443, out through the ADSL router.</p>
<p>Yeah, it’s not quite the most elegant solution, but it’s a <strong>simple solution</strong>.</p>
<hr>
<p>But your default gateway is WAN_PPPOE?</p>
<p>Yeah, you saw that huh? Yes, the above example is theoretically useless because, unless otherwise instructed by a firewall rule, <strong>all traffic</strong> will go out via the ADSL link. But that’s just this point in time. By the time this series is finished, I hope to have my 4G link set up as my default route, either implicitly via discrete firewall rules as I’ve just demonstrated, or explicitly via the default gateway option.</p>

              </div>
            </section>
          </article>
        </div>
      </main>

      <aside class="read-next outer"></aside>

      

    <footer class="site-footer outer"></footer>

    </div>
  </body>
</html>